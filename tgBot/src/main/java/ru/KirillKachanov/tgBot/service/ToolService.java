package ru.KirillKachanov.tgBot.service;

import org.springframework.ai.tool.annotation.Tool; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é @Tool
import org.springframework.stereotype.Service;
import ru.KirillKachanov.tgBot.entity.ClientOrder;
import ru.KirillKachanov.tgBot.entity.OrderProduct;

import java.util.List;
import java.util.logging.Logger;

@Service // –£–∫–∞–∑—ã–≤–∞–µ—Ç Spring, —á—Ç–æ —ç—Ç–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (–±–∏–Ω), –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å—Å—è Spring-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º.
public class ToolService {

    private static final Logger LOGGER = Logger.getLogger(ToolService.class.getName());

    private final EntitiesService entitiesService;

    // –í–Ω–µ–¥—Ä—è–µ–º EntitiesService —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä. –û–Ω –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º.
    public ToolService(EntitiesService entitiesService) {
        this.entitiesService = entitiesService;
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ –ø–æ –µ–≥–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É.
     * @param orderId –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–∫–∞–∑–∞.
     * @return –°—Ç—Ä–æ–∫–∞ —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–∞–∫–∞–∑–µ.
     */
    @Tool(name = "getOrderDetails", description = "–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ –ø–æ –µ–≥–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É (orderId). –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ —Å—Ç–∞—Ç—É—Å–µ, —Å–æ–¥–µ—Ä–∂–∏–º–æ–º –∏–ª–∏ –¥–µ—Ç–∞–ª—è—Ö —Å–≤–æ–µ–≥–æ –∑–∞–∫–∞–∑–∞. –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞: '–ì–¥–µ –º–æ–π –∑–∞–∫–∞–∑ 123?', '–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ 456'.")
    public String getOrderDetails(String orderId) {
        LOGGER.info("–í—ã–∑–≤–∞–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç getOrderDetails –¥–ª—è orderId: " + orderId);
        if (orderId == null || orderId.isEmpty()) {
            return "–ù–µ –º–æ–≥—É –Ω–∞–π—Ç–∏ –∑–∞–∫–∞–∑ –±–µ–∑ –µ–≥–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞.";
        }

        try {
            Long id = Long.parseLong(orderId);
            ClientOrder order = entitiesService.getOrderById(id);

            if (order == null) {
                return "–ó–∞–∫–∞–∑ —Å –Ω–æ–º–µ—Ä–æ–º " + orderId + " –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Ç–æ—á–Ω–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞.";
            }

            StringBuilder details = new StringBuilder("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ ‚Ññ" + order.getId() + ":\n");
            details.append("–°—Ç–∞—Ç—É—Å: ").append(order.getStatus()).append("\n");

            List<OrderProduct> products = entitiesService.getOrderProducts(order);
            if (products.isEmpty()) {
                details.append("–í –∑–∞–∫–∞–∑–µ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤.\n");
            } else {
                details.append("–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:\n");
                for (OrderProduct op : products) {
                    details.append("- ").append(op.getProduct().getName())
                            .append(" (").append(op.getCountProduct()).append(" —à—Ç.)\n");
                }
            }

            details.append("–û–±—â–∞—è —Å—É–º–º–∞: ").append(entitiesService.calculateOrderTotal(order)).append(" —Ä—É–±.\n");
            // –î–æ–±–∞–≤–∏–º –ø—Ä–∏–º–µ—Ä—ã –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∫–∞–∫ –≤ –∑–∞–¥–∞–Ω–∏–∏
            details.append("–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏: ").append(order.getClient().getAddress() != null ? order.getClient().getAddress() : "–Ω–µ —É–∫–∞–∑–∞–Ω").append("\n");
            details.append("–û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏: 90 –º–∏–Ω—É—Ç."); // –ü—Ä–∏–º–µ—Ä –∏–∑

            return details.toString();
        } catch (NumberFormatException e) {
            return "–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–∫–∞–∑–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–º–µ—Ä.";
        } catch (Exception e) {
            LOGGER.severe("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞ " + orderId + ": " + e.getMessage());
            return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–∫–∞–∑–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
        }
    }

    /**
     * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     * @param message –¢–µ–∫—Å—Ç –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ—Ç–∑—ã–≤–∞.
     * @return –°–æ–æ–±—â–µ–Ω–∏–µ —Å –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å—é.
     */
    @Tool(name = "submitPositiveFeedback", description = "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤, –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–µ–π –∏–ª–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–∞–ø—Ä–∏–º–µ—Ä: '–í—Å–µ –æ—Ç–ª–∏—á–Ω–æ!', '–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑!', '–û—á–µ–Ω—å –¥–æ–≤–æ–ª–µ–Ω –≤–∞—à–µ–π —Ä–∞–±–æ—Ç–æ–π'.")
    public String submitPositiveFeedback(String message) {
        LOGGER.info("–ü–æ–ª—É—á–µ–Ω –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤: " + message);
        // –ó–¥–µ—Å—å –º–æ–≥–ª–∞ –±—ã –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        return "–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤! –ú—ã —Ä–∞–¥—ã, —á—Ç–æ –≤—ã –¥–æ–≤–æ–ª—å–Ω—ã. –í–∞—à–µ –º–Ω–µ–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞–º —Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –ª—É—á—à–µ. üòä";
    }

    /**
     * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤ –∏–ª–∏ –∂–∞–ª–æ–±—É –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     * @param message –¢–µ–∫—Å—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ –æ—Ç–∑—ã–≤–∞/–∂–∞–ª–æ–±—ã.
     * @return –°–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞.
     */
    @Tool(name = "submitNegativeFeedback", description = "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤, –∂–∞–ª–æ–± –∏–ª–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–∞–ø—Ä–∏–º–µ—Ä: '–ó–∞–∫–∞–∑ –æ–ø–æ–∑–¥–∞–ª', '–ï–¥–∞ –±—ã–ª–∞ —Ö–æ–ª–æ–¥–Ω–æ–π', '–Ø –Ω–µ–¥–æ–≤–æ–ª–µ–Ω –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ–º'.")
    public String submitNegativeFeedback(String message) {
        LOGGER.info("–ü–æ–ª—É—á–µ–Ω –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤: " + message);
        // –ó–¥–µ—Å—å –º–æ–≥–ª–∞ –±—ã –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∂–∞–ª–æ–±—ã –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏
        return "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤. –ú—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–±–µ—Ä—ë–º—Å—è –∏ –ø–æ—Å—Ç–∞—Ä–∞–µ–º—Å—è —Å—Ç–∞—Ç—å –ª—É—á—à–µ. –ò–∑–≤–∏–Ω–∏—Ç–µ –∑–∞ –≤–æ–∑–º–æ–∂–Ω—ã–µ –Ω–µ—É–¥–æ–±—Å—Ç–≤–∞. üôè";
    }

    /**
     * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ–º–æ—â—å.
     * @param userMessage –ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å.
     * @return –°–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ–º–æ—â–∏ –∏–ª–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞.
     */
    @Tool(name = "fallbackHelp", description = "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ, –µ—Å–ª–∏ –±–æ—Ç –Ω–µ –º–æ–∂–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ —Å–≤—è–∂–µ—Ç—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä. –ü—Ä–∏–º–µ—Ä: '–Ø –Ω–µ –ø–æ–Ω—è–ª', '–ü–æ–º–æ–≥–∏—Ç–µ', '–ö–∞–∫ –º–Ω–µ...', '–ß—Ç–æ –≤—ã —É–º–µ–µ—Ç–µ?'.")
    public String fallbackHelp(String userMessage) {
        LOGGER.info("–ü–æ–ª—É—á–µ–Ω–æ –Ω–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: " + userMessage + ". –í—ã–∑–≤–∞–Ω fallbackHelp.");
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã —Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –≤ CRM –∏–ª–∏ —É–≤–µ–¥–æ–º–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞.
        return "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å. –° –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å. üßë‚Äçüíª";
    }
}